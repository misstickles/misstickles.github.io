---
title: GitHub logs
description: Analysing GitHub logs
output: html_document
---

<https://github.com/lorenzwalthert/gitsum>

```{r setup}
rm(list = ls())
library(gitsum)
library(tidyverse)
library(forcats)
```

```{r}
init_gitsum()

df <- parse_log_detailed() %>%
  select(short_hash, short_message, total_files_changed, nested)

df

df$nested[[1]]
```

```{r}
log <- parse_log_detailed()
log %>%
  group_by(author_name) %>%
  summarise(n = n())
```

```{r}
lines <- log %>%
  unnest_log() %>%
  set_changed_file_to_latest_name() %>%
  add_line_history()
```

```{r}

log
names(log)
```

```{r}
log %>%
  mutate(weekday = factor(weekday, c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))) %>%
  ggplot(aes(x = weekday)) +
  geom_bar() +
  theme_minimal()
```



```{r}
report_git()

parse_log_detailed_full_run()
```

```{r}
names(log)
summary(log)
head(log)

x <- log %>% filter(short_hash == "c152")
View(x)

y <- log %>% filter(is_merge == TRUE)
View(y)

View(log)
```

`git log --stat --parents --stat-width 99999`

`git log --pretty=format:"%h %ad" --numstat`

The unnested column names are:
- short_hash      %h
- author_name     %an
- date            %ad
- hash            %H
- parent          %P  (then do the split for right parent)
- author_email    %ae
- message         %s (subject)
- description     %b  (or %B?)

Calculate:
- weekday
- month
- monthday
- time
- year
- timezone
- left_parent
- right_parent
- is_merge  ???  is_merge = ifelse(!is.na(.data$left_parent) & !is.na(.data$right_parent), TRUE, FALSE

The nested columns contain more information on each commit. The column names are:
- changed_file
- edits
- insertions
- deletions

Calculate:
- total_files_changed
- total_insertions
- total_deletions


# Wrangle the Logs

Create a string to collect the logs in our required format.

```{r}
# https://www.r-bloggers.com/2018/03/guide-to-tidy-git-analysis/
log_format_options <- c(
  # description = "b",
  short_hash = "h", hash = "H",
  author_name = "an", author_email = "ae",
  author_datetime = "ai", commetter_name = "cn",
  comitter_datetime = "ci", parents = "P",
  subject = "s"
)

options_delimiter <- "~~~"

log_format <- str_glue("%{log_format_options}") %>%
  str_c(collapse = options_delimiter)

log_options <- str_glue(
  '--pretty=format:"{log_format}"',
  #  ' --date=format:"%Y-%m-%d %H:%M:%S"',
  " --branches --numstat"
)
```

```{r}
# git_cmd <- str_glue("git -C D:/git/updater --no-pager log {log_options}")
git_cmd <- str_glue("git --no-pager log {log_options}")

print(git_cmd)

raw_log <- system(git_cmd, intern = TRUE)
View(raw_log)

df <- data.frame(log = character(), files = character())

git_log <- raw_log %>%
  str_split_fixed(options_delimiter, length(log_format_options)) %>%
  as_tibble() %>%
  setNames(names(log_format_options)) %>%
  mutate(
    commit_count = cumsum(hash != ""),
    type = ifelse(hash != "", "g", "f")
  ) %>%
  subset(short_hash != "")

View(git_log)


parse_row <- function(raw) {
  print(raw)
  tibble::tibble(
    hash = raw$hash
  )
}

n <- git_log %>%
  group_by(commit_count) %>%
  do(nested = parse_row(.)) %>%
  ungroup()
View(n)

log_lines <- nrow(git_log)

g <- git_log %>%
  group_by(commit_count)
nrow(g)

for (i in 0:log_lines) {
  log <- g[i]

  while()
}


r <- git_log %>%
  str_split_fixed(options_delimiter, length(log_format_options)) %>%
  #  str_split_fixed("\t", 3) %>% #length(c(insertions = 1, deletions = 2, filename = 3))) %>%
  as_tibble() %>%
  mutate(
    commit_count = cumsum(grepl(options_delimiter, V1))
  ) %>%
  group_by(commit_count) %>%
  nest(data = select(V1, contains("\t"))) %>%
  ungroup()

View(r)
head(r)
head(r$data)

p <- function(v) {
  Reduce(f = paste0, x = v)
}

agg <- aggregate(type ~ value, data = raw, paste0, collapse = "")

df <- merge(raw, agg, by = "value", all = TRUE)
View(df)
z <- raw %>%
  mutate(
    type = ifelse(grepl("~~~", value), "g", "f")
  ) %>%
  summarise(files = p(as.character(bar[type == "f"])))
pivot_wider(names_from = type, values_from = value)

View(z)

p <- git_log %>%
  as_tibble() %>%
  group_by(grp = cumsum(grepl(options_delimiter, value))) %>%
  mutate(rn = row_number()) %>%
  ungroup() %>%
  pivot_wider(names_from = grp, values_from = value)
View(p)


q <- git_log %>%
  as_tibble() %>%
  mutate(
    commit_count = cumsum(grepl(options_delimiter, value))
  ) %>%
  group_by(commit_count) %>%
  mutate(rn = row_number()) %>%
  ungroup() %>%
  group_by(grp = str_c("Column", rep(1:4, length.out = n()))) %>%
  ungroup() %>%
  pivot_wider(names_from = grp, values_from = value)
View(q)

##  keep this !!!!!
str_split_fixed(options_delimiter, length(log_format_options)) %>%
  setNames(names(log_format_options)) %>%
  mutate(
    parent_left = str_split(parents, " ")[1],
    parent_right = str_split(parents, " ")[2],
    files = str_split_fixed(short_hash, "\t", 3)
  )

v <- aggregate()
head(git_log)

v <- aggregate(lines ~ commit_count, t, I)
View(v)
```

```{r}
parse_commit <- function(commit) {

}

get_file_info <- function(commit) {

}

```

